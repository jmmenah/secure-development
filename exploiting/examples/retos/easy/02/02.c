#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <signal.h>

// --------------------------------------------------- SETUP
void ignore_me_init_buffering() {
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);
}

void kill_on_timeout(int sig) {
  if (sig == SIGALRM) {
        printf("[!] Anti DoS Signal.");
        _exit(0);
  }
}

void ignore_me_init_signal() {
	signal(SIGALRM, kill_on_timeout);
	alarm(60);
}
// ----------------------------------------------------- SETUP
    
#define MAX  5
#define MAXNAME 160
#define MAXTELEPHONE 16

struct contact {
    char name[MAXNAME];
    char telephone[MAXTELEPHONE];
};
typedef struct contact tcontact;


void menu() {
    printf("=================================\n");
    printf("==============  PPS =============\n");
    printf("=================================\n");
    printf("1- Nuevo contacto\n");
    printf("2- Ver contactos\n");
    printf("3- Salir\n");
    printf("=================================\n");
    printf("Selecciona opción: ");
}

void reset(tcontact contacts[MAX]) {
    for (int i = 0; i < MAX; i++) {
        contacts[i].name[0] = '\0';
        contacts[i].telephone[0] = '\0';
    }
}

void view(tcontact contacts[MAX]) {
    for (int i = 0; i < MAX; i++) {
        printf("\n================\n");
        printf("Contacto: %d\n",i);
        printf("================\n");
        printf(contacts[i].name);
        printf(contacts[i].telephone);
        printf("================\n");
    }
}

void new(tcontact contacts[MAX], int ncontact) {

    if (ncontact >= 0 && ncontact < MAX) {
        printf("Contacto %d\n", ncontact);        
        printf("Escribe el nombre: ");
        fgets(contacts[ncontact].name, MAXNAME, stdin);
        printf("Escribe el teléfono: ");
        fgets(contacts[ncontact].telephone, MAXTELEPHONE, stdin);
    } else {
        printf("No se puede guardar ese contacto.\n");
    }
}

int start_level() {
    tcontact contacts[MAX];
    char buff[16];
    int opcion;
    unsigned ncontact;
    reset(contacts);

    do {
        menu();
        fflush(stdout);
        fgets(buff, 10, stdin);
        opcion = atoi(buff);
        printf("%d\n", opcion);
        switch (opcion)
        {
            case 1:
                printf("Nº de contacto a guardar [0 - %d]: ", MAX-1);
                fgets(buff, 10, stdin);
                ncontact = atoi(buff);
                new(contacts, ncontact);
                break;
            case 2:
                view(contacts);
                break;
            case 3:
                break;
            default:
                printf("Opción no válida");
                break;
        }
    } while(opcion != 3);
}

int main() {
  ignore_me_init_buffering(); //Modo buffers unbuffered.
  ignore_me_init_signal();  //Evita ataques DoS.

  start_level();
}
