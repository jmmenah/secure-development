#include <unistd.h>
#include <sys/types.h>
#include <stdlib.h>
#include <stdio.h>
#include <signal.h>
#include <unistd.h>

// --------------------------------------------------- SETUP

void ignore_me_init_buffering() {
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);
}

void kill_on_timeout(int sig) {
  if (sig == SIGALRM) {
        printf("[!] Anti DoS Signal.");
        _exit(0);
  }
}

void ignore_me_init_signal() {
	signal(SIGALRM, kill_on_timeout);
	alarm(60);
}

// ----------------------------------------------------- SETUP


  
int main() {
  int var;
  int check = 0x04030201;
  char buf[40];

  ignore_me_init_buffering(); //Modo buffers unbuffered.
	ignore_me_init_signal();  //Evita ataques DoS.

  //fgets es una función segura. Pero el programador debe
  //controlar correctamente los límites.
  //El buffer se desborda en 5 bytes. Permite modificar variable ckeck
  fgets(buf,45,stdin);
  
  printf("\n[buf]: %s\n", buf);
  printf("[check] %p\n", check);
  
  if ((check != 0x04030201) && (check != 0xdeadbeef))
    printf ("\nYou are on the right way!\n");
  
  if (check == 0xdeadbeef)
    {
      printf("Yeah dude! You win!\nOpening your shell...\n");
      setreuid(geteuid(), geteuid());
      system("/bin/bash");
      printf("Shell closed! Bye.\n");
    }
    return 0;
}
