#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>
#include <signal.h>
#include <err.h>
#include <string.h>

// --------------------------------------------------- SETUP
void ignore_me_init_buffering() {
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);
}

void kill_on_timeout(int sig) {
  if (sig == SIGALRM) {
        printf("[!] Anti DoS Signal.");
        _exit(0);
  }
}

void ignore_me_init_signal() {
	signal(SIGALRM, kill_on_timeout);
	alarm(60);
}
// ----------------------------------------------------- SETUP
 

int main(int argc, char **argv) {
  struct {
    char buffer[64];
    volatile int changeme;
  } locals;

  char *ptr;

  ignore_me_init_buffering(); //Modo buffers unbuffered.
	ignore_me_init_signal();  //Evita ataques DoS.


  ptr = getenv("CONFIGURATION");
  if (ptr == NULL) {
    errx(1, "Por favor establece la variable de entorno");
  }

  locals.changeme = 0;
  //strcpy es una función vulnerable. Copia un string a otro pero no controla
  //el tamaño del buffer de destino.
  //Se puede sobreescribir la pila.
  strcpy(locals.buffer, ptr);

  if (locals.changeme == 0x0d0a090a) {
    puts("You win!!!!\n");
  } else {
    printf("Nope\n");
  }

  exit(0);
}
